---
- name: Install
  hosts: localhost
  strategy: free
  vars_files:
    - vars/default.yaml
    - "vars/{{ ansible_facts['hostname'] }}.yaml"
  tasks:
    - name: Subscribe to Package Provider
      tags: brew
      ansible.builtin.homebrew_tap:
        name: "{{ item }}"
        state: present
      loop:
        - hashicorp/tap

    - name: Install Packages
      tags: brew
      ansible.builtin.package:
        package: "{{ item }}"
        state: present
      loop:
        - argocd
        - argocd-vault-plugin
        - eksctl
        - fish
        - gdbm
        - git
        - gnu-sed
        - gnupg
        - grep
        - groff
        - guile
        - hashicorp/tap/terraform
        - helm
        - htop
        - jq
        - kind
        - kubernetes-cli
        - kubeseal
        - kustomize
        - libiscsi
        - librdkafka
        - libserdes
        - lua@5.3
        - mpdecimal
        - nmap
        - node
        - parallel
        - qemu
        - rush-parallel
        - shellcheck
        - sqlite
        - starship
        - telnet
        - tmux
        - tree
        - vault
        - watch
        - yajl

    - name: Uninstall Packages
      tags: brew
      ansible.builtin.package:
        package: "{{ item }}"
        state: absent
      loop:
        - kics

    - name: Install Kubernetes CLI plugins
      tags: krew
      block:
        - name: Install Krew
          ansible.builtin.shell: |
            set -x; cd "$(mktemp -d)" &&
            OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
            ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" &&
            KREW="krew-${OS}_${ARCH}" &&
            curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
            tar zxvf "${KREW}.tar.gz" &&
            ./"${KREW}" install krew &&
            $HOME/.krew/bin/kubectl-krew update
        - name: Install plugins with Krew
          ansible.builtin.shell: "$HOME/.krew/bin/kubectl-krew install {{ item }}"
          loop:
            - access-matrix
            - blame
            - ctx
            - ktop
            - kubescape
            - lineage
            - neat
            - node-shell
            - ns
            - score
            - sick-pods
            - slice
            - stern
            - tree
            - view-secret
